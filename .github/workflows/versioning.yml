name: Versioning and Publish with LTS Failover

on:
  push:
    branches:
      - main
    tags:
      - 'v*'  # Trigger when a version tag is created (v1.0.0, v1.1.0, etc.)
      - 'vlts-*'  # Trigger when a tag starting with 'vlts-' is created for LTS versions

jobs:
  versioning:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '16'  # Adjust for your project needs

    - name: Install dependencies
      run: npm install

    - name: Increment version
      run: |
        # Increment version using npm or a custom versioning method
        npm version patch -m "Bump version to %s" # Use major/minor/patch depending on your logic

    - name: Push version tag and changes
      run: |
        git push --follow-tags

    - name: Publish new version to GitHub Packages
      run: npm publish --registry https://npm.pkg.github.com
      env:
        NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      continue-on-error: true  # Continue even if publish fails, we will handle failure

  failover-to-lts:
    runs-on: ubuntu-latest
    needs: versioning
    if: failure()  # This will run only if the versioning job fails
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '16'  # Adjust for your project needs

    - name: Install dependencies
      run: npm install

    - name: Deploy LTS version
      run: |
        echo "Deployment failed, rolling back to LTS version"
        # Rollback to the LTS version, either by using a previously tagged version or by deploying manually
        npm install @your-org/your-lts-version
        npm publish --registry https://npm.pkg.github.com
      env:
        NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  manual-lts-push:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/vlts-') # This allows you to manually trigger LTS versions by creating a tag like 'vlts-1.0.0'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '16'

    - name: Install dependencies
      run: npm install

    - name: Publish LTS version to GitHub Packages
      run: |
        echo "Publishing LTS version"
        # Directly publish the LTS version without changing the version in package.json
        npm publish --registry https://npm.pkg.github.com
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NODE_AUTH_TOKEN }}
